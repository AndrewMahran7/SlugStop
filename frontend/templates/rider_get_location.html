<!DOCTYPE html>
<html>
<head>
    <title>Find Closest Stop | SlugStop</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/static/rider.css">
</head>
<body>
    <div class="header">
        Find Your Stop
        <a href="/" class="home-btn">Home</a>
    </div>
    <div class="container">
        <button id="locateBtn">ðŸšŒ Find Buses Near Me</button>
        <div id="loading" style="display: none;">Getting your location...</div>
        <div id="error" class="error" style="display: none;"></div>
        
        <h3>Or select a location manually:</h3>
        <ul id="stopsList">
            <!-- Populated by JavaScript -->
        </ul>
    </div>
    
    <script>
        let stops = [];
        
        // Load stops on page load
        async function loadStops() {
            try {
                // Load METRO routes and their stops
                const response = await fetch('/api/metro/routes');
                const data = await response.json();
                
                if (data.success) {
                    // Extract unique stops from all routes
                    const uniqueStops = new Map();
                    
                    data.routes.forEach(route => {
                        route.stops.forEach(stop => {
                            uniqueStops.set(stop.id, {
                                id: stop.id,
                                name: stop.name,
                                lat: stop.location.coordinates[1],
                                lon: stop.location.coordinates[0]
                            });
                        });
                    });
                    
                    stops = Array.from(uniqueStops.values());
                    populateStopsList();
                }
            } catch (error) {
                console.error('Error loading stops:', error);
            }
        }
        
        // Populate manual stops selection
        function populateStopsList() {
            const stopsListEl = document.getElementById('stopsList');
            stopsListEl.innerHTML = '';
            
            stops.forEach(stop => {
                const li = document.createElement('li');
                li.innerHTML = `<button onclick="selectStop(${stop.lat}, ${stop.lon}, '${stop.name}')">${stop.name}</button>`;
                stopsListEl.appendChild(li);
            });
        }
        
        // Select stop manually
        function selectStop(lat, lon, name) {
            window.location.href = `/rider-select?lat=${lat}&lon=${lon}`;
        }
        
        // Find buses near user's current location
        document.getElementById('locateBtn').onclick = async function() {
            if (!navigator.geolocation) {
                document.getElementById('error').textContent = 'Geolocation not supported by your browser.';
                document.getElementById('error').style.display = 'block';
                return;
            }
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            
            navigator.geolocation.getCurrentPosition(function(pos) {
                // Go directly to bus finder map with user's location
                window.location.href = `/rider-select?lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`;
            }, function(error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').textContent = 'Could not get your location. Please try again or select a location manually.';
                document.getElementById('error').style.display = 'block';
            });
        };
        
        // Load stops when page loads
        document.addEventListener('DOMContentLoaded', loadStops);
    </script>
</body>
</html>