<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard | SlugStop</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/static/admin.css">
</head>
<body>
    <div class="header">
        Admin Dashboard
        <a href="/" class="home-btn">Home</a>
    </div>
    
    <div class="admin-controls">
        <div>Logged in as: <b id="adminName">Loading...</b></div>
        <button id="refreshBtn">Refresh Data</button>
        <button id="logoutBtn">Logout</button>
    </div>
    
    <div class="dashboard-content">
        <div class="stats-section">
            <h3>System Statistics</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="activeDrivers">0</div>
                    <div class="stat-label">Active Drivers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalStops">0</div>
                    <div class="stat-label">Total Stops</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalRoutes">0</div>
                    <div class="stat-label">Routes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalDrivers">0</div>
                    <div class="stat-label">Total Drivers</div>
                </div>
            </div>
        </div>
        
        <div class="drivers-section">
            <h3>Active Drivers</h3>
            <div id="driversList">Loading...</div>
        </div>
    </div>
    
    <script>
        // Check if user is logged in
        const adminToken = localStorage.getItem('adminToken');
        const adminUser = JSON.parse(localStorage.getItem('adminUser') || '{}');
        
        if (!adminToken || !adminUser.name) {
            alert('Please log in first');
            window.location.href = '/admin/login';
            throw new Error('No authentication'); // Stop script execution
        }
        
        // Display admin name
        document.getElementById('adminName').textContent = adminUser.name;
        
        // Load dashboard data
        async function loadDashboardData() {
            try {
                const response = await fetch('/admin/dashboard', {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    // Check for authentication errors first
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('adminToken');
                        localStorage.removeItem('adminUser');
                        alert('Session expired. Please log in again.');
                        window.location.href = '/admin/login';
                        return;
                    }
                    
                    // Try to get error message from response
                    const errorData = await response.json().catch(() => ({}));
                    if (errorData.error === 'Access token required') {
                        localStorage.removeItem('adminToken');
                        localStorage.removeItem('adminUser');
                        window.location.href = '/admin/login';
                        return;
                    }
                    
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Update stats
                document.getElementById('activeDrivers').textContent = data.stats.activeDrivers;
                document.getElementById('totalStops').textContent = data.stats.totalStops;
                document.getElementById('totalRoutes').textContent = data.stats.totalRoutes;
                document.getElementById('totalDrivers').textContent = data.stats.totalDrivers;
                
                // Update drivers list
                const driversList = document.getElementById('driversList');
                if (data.activeDrivers && data.activeDrivers.length > 0) {
                    driversList.innerHTML = data.activeDrivers.map(driver => `
                        <div class="driver-item">
                            <span>${driver.name} (Bus ${driver.busNumber || 'N/A'})</span>
                            <span>${driver.onShift ? 'On Shift' : 'Off Shift'}</span>
                        </div>
                    `).join('');
                } else {
                    driversList.innerHTML = '<div class="no-data">No active drivers</div>';
                }
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                alert('Error loading dashboard data. Please try again.');
                // Don't redirect on network errors, just show the error
            }
        }
        
        // Event listeners
        document.getElementById('refreshBtn').onclick = loadDashboardData;
        
        document.getElementById('logoutBtn').onclick = function() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUser');
            window.location.href = '/admin/login';
        };
        
        // Load data on page load
        loadDashboardData();
    </script>
</body>
</html>
